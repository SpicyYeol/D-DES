<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="common"> 
    <insert id="insertUser">
        INSERT INTO 
        USER (
                user_type,
                user_name,
                user_address,
                user_email,
                user_phone
            )
        VALUES (
                #{userType},
                #{userName},
                #{userAddress},
                #{userEmail},
                #{userPhone}
            )
    </insert>
    
    <insert id="insertTask">
        INSERT INTO
        TASK (
                user_id,
                task_name,
                task_status_code,
                task_contract_address,
                task_purpose,
                task_framework,
                task_data_type,
                task_max_trainer,
                task_port
            )
        VALUES
            (
                #{userId},
                #{taskName},
                #{taskStatusCode},
                #{taskContractAddress},
                #{taskPurpose},
                #{taskFramework},
                #{taskDataType},
                #{taskMaxTrainer},
                #{taskPort}
            )
    </insert>

    <select id="getUser">
        SELECT * 
        FROM USER 
        WHERE user_address=#{userAddress} 
        AND use_yn='Y'
    </select>

    <select id="getTask">
        SELECT tu.* ,
        @rownum := @rownum +1 AS row_num
        FROM 
            (SELECT t.task_id,
                t.task_name,
                t.task_status_code,
                t.task_contract_address,
                t.task_purpose,
                t.task_framework,
                t.task_data_type,
                t.task_max_trainer,
                t.task_port,
                u.user_id AS organization_user_id,
                u.user_name
            FROM TASK t, USER u
            WHERE t.user_id = u.user_id
             <if test="organizationUserId != null">
    	        AND u.user_id = #{organizationUserId}
             </if>
             <if test="taskStatusCode != null">
    	        AND t.task_status_code = #{taskStatusCode}
             </if>
            ) tu,
            (SELECT @rownum:=0) r
        WHERE
        lower(tu.task_name) like lower(CONCAT('%', #{searchText}, '%')) OR lower(tu.user_name) like lower(CONCAT('%', #{searchText}, '%')) 
        ORDER BY task_id DESC
    </select>   

</mapper>